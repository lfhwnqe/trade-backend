/**
 * è„‘å›¾åˆ—è¡¨APIæµ‹è¯•
 * éªŒè¯ç‚¹ï¼šå¯ä»¥æˆåŠŸèŽ·å–è„‘å›¾åˆ—è¡¨
 */

import { MindMapService } from '../mindmap.service';
import { ConfigService } from '@nestjs/config';
import { MindMapQueryParams, MINDMAP_DEFAULTS } from '../types/mindmap.types';

// æ¨¡æ‹Ÿå­˜å‚¨çš„è„‘å›¾æ•°æ®
const mockMindMapList = [
  {
    PK: 'USER#test-user-123',
    SK: 'MINDMAP#mindmap-001',
    id: 'mindmap-001',
    userId: 'test-user-123',
    title: 'ç¬¬ä¸€ä¸ªè„‘å›¾',
    description: 'è¿™æ˜¯ç¬¬ä¸€ä¸ªæµ‹è¯•è„‘å›¾',
    layout: MINDMAP_DEFAULTS.LAYOUT,
    theme: MINDMAP_DEFAULTS.THEME,
    tags: ['æµ‹è¯•', 'ç¬¬ä¸€ä¸ª'],
    version: MINDMAP_DEFAULTS.VERSION,
    createdAt: '2025-07-01T10:00:00.000Z',
    updatedAt: '2025-07-01T10:00:00.000Z',
  },
  {
    PK: 'USER#test-user-123',
    SK: 'MINDMAP#mindmap-002',
    id: 'mindmap-002',
    userId: 'test-user-123',
    title: 'ç¬¬äºŒä¸ªè„‘å›¾',
    description: 'è¿™æ˜¯ç¬¬äºŒä¸ªæµ‹è¯•è„‘å›¾',
    layout: 'mindMap',
    theme: 'classic',
    tags: ['æµ‹è¯•', 'ç¬¬äºŒä¸ª'],
    version: MINDMAP_DEFAULTS.VERSION,
    createdAt: '2025-07-02T10:00:00.000Z',
    updatedAt: '2025-07-02T11:00:00.000Z',
  },
  {
    PK: 'USER#test-user-123',
    SK: 'MINDMAP#mindmap-003',
    id: 'mindmap-003',
    userId: 'test-user-123',
    title: 'ç¬¬ä¸‰ä¸ªè„‘å›¾',
    description: 'è¿™æ˜¯ç¬¬ä¸‰ä¸ªæµ‹è¯•è„‘å›¾',
    layout: MINDMAP_DEFAULTS.LAYOUT,
    theme: MINDMAP_DEFAULTS.THEME,
    tags: ['å·¥ä½œ', 'é¡¹ç›®'],
    version: MINDMAP_DEFAULTS.VERSION,
    createdAt: '2025-07-02T12:00:00.000Z',
    updatedAt: '2025-07-02T13:00:00.000Z',
  },
];

// æ¨¡æ‹ŸDynamoDBæ“ä½œ
const mockDynamoDBDocument = {
  put: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB PUTæ“ä½œ');
    return { $metadata: { httpStatusCode: 200 } };
  },
  get: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB GETæ“ä½œ');
    return { Item: null };
  },
  delete: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB DELETEæ“ä½œ');
    return { $metadata: { httpStatusCode: 200 } };
  },
  query: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB QUERYæ“ä½œ:', {
      KeyConditionExpression: params.KeyConditionExpression,
      ExpressionAttributeValues: params.ExpressionAttributeValues,
      FilterExpression: params.FilterExpression,
      Limit: params.Limit,
    });

    // æ¨¡æ‹ŸæŸ¥è¯¢ç”¨æˆ·çš„è„‘å›¾åˆ—è¡¨
    if (params.KeyConditionExpression?.includes('PK = :pk') &&
        params.ExpressionAttributeValues?.[':pk'] === 'USER#test-user-123') {
      let items = [...mockMindMapList];

      // æ¨¡æ‹Ÿæ ‡ç­¾è¿‡æ»¤
      if (params.FilterExpression?.includes('contains(tags')) {
        // ä»ŽExpressionAttributeValuesä¸­æå–æ ‡ç­¾å€¼
        const filterTags = Object.keys(params.ExpressionAttributeValues)
          .filter(key => key.startsWith(':tag'))
          .map(key => params.ExpressionAttributeValues[key]);

        items = items.filter(item =>
          item.tags.some(tag => filterTags.includes(tag))
        );
      }

      // æ¨¡æ‹Ÿåˆ†é¡µ
      const limit = params.Limit || 10;
      const startIndex = params.ExclusiveStartKey ? 1 : 0;
      const endIndex = Math.min(startIndex + limit, items.length);
      const paginatedItems = items.slice(startIndex, endIndex);

      const result: any = {
        Items: paginatedItems,
        Count: paginatedItems.length,
        ScannedCount: paginatedItems.length,
      };

      // æ¨¡æ‹Ÿåˆ†é¡µé”®
      if (endIndex < items.length) {
        result.LastEvaluatedKey = {
          PK: paginatedItems[paginatedItems.length - 1].PK,
          SK: paginatedItems[paginatedItems.length - 1].SK,
        };
      }

      return result;
    }

    return { Items: [], Count: 0 };
  },
};

// æ¨¡æ‹ŸConfigService
const mockConfigService = {
  getOrThrow: (key: string) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || `mock-${key}`;
  },
  get: (key: string, defaultValue?: any) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || defaultValue;
  },
} as ConfigService;

async function testListMindMapAPI() {
  console.log('ðŸ§ª å¼€å§‹æµ‹è¯•è„‘å›¾åˆ—è¡¨API...');
  
  try {
    // åˆ›å»ºæœåŠ¡å®žä¾‹
    const mindMapService = new MindMapService(mockConfigService);
    
    // æ¨¡æ‹ŸDynamoDBå®¢æˆ·ç«¯
    (mindMapService as any).db = mockDynamoDBDocument;
    
    // æµ‹è¯•1: èŽ·å–åŸºç¡€åˆ—è¡¨ï¼ˆæ— è¿‡æ»¤æ¡ä»¶ï¼‰
    console.log('\nðŸ“ æµ‹è¯•1: èŽ·å–åŸºç¡€åˆ—è¡¨');
    const userId = 'test-user-123';
    const basicQuery: MindMapQueryParams = {
      page: 1,
      pageSize: 10,
    };
    
    console.log('ç”¨æˆ·ID:', userId);
    console.log('æŸ¥è¯¢å‚æ•°:', basicQuery);
    
    console.log('ðŸš€ è°ƒç”¨è„‘å›¾åˆ—è¡¨API...');
    const basicResult = await mindMapService.getMindMapList(userId, basicQuery);
    
    console.log('âœ… èŽ·å–æˆåŠŸï¼');
    console.log('è¿”å›žç»“æžœ:');
    console.log('- æ€»æ•°:', basicResult.total);
    console.log('- å½“å‰é¡µ:', basicResult.page);
    console.log('- é¡µå¤§å°:', basicResult.pageSize);
    console.log('- è„‘å›¾æ•°é‡:', basicResult.items.length);
    console.log('- æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ:', basicResult.hasMore);
    
    // éªŒè¯åŸºç¡€åˆ—è¡¨ç»“æžœ
    const basicValidations = [
      { field: 'total', value: basicResult.total, check: (v) => v === 3 },
      { field: 'page', value: basicResult.page, check: (v) => v === 1 },
      { field: 'pageSize', value: basicResult.pageSize, check: (v) => v === 10 },
      { field: 'items.length', value: basicResult.items.length, check: (v) => v === 3 },
      { field: 'items[0].id', value: basicResult.items[0]?.id, check: (v) => v === 'mindmap-001' },
      { field: 'items[0].title', value: basicResult.items[0]?.title, check: (v) => v === 'ç¬¬ä¸€ä¸ªè„‘å›¾' },
    ];
    
    let allValid = true;
    for (const validation of basicValidations) {
      const isValid = validation.check(validation.value);
      if (isValid) {
        console.log(`âœ… ${validation.field}: éªŒè¯é€šè¿‡`);
      } else {
        console.log(`âŒ ${validation.field}: éªŒè¯å¤±è´¥`, validation.value);
        allValid = false;
      }
    }
    
    // æµ‹è¯•2: å¸¦æ ‡ç­¾è¿‡æ»¤çš„åˆ—è¡¨
    console.log('\nðŸ“ æµ‹è¯•2: å¸¦æ ‡ç­¾è¿‡æ»¤çš„åˆ—è¡¨');
    const tagQuery: MindMapQueryParams = {
      page: 1,
      pageSize: 10,
      tags: ['æµ‹è¯•'],
    };
    
    console.log('æŸ¥è¯¢å‚æ•°:', tagQuery);
    
    console.log('ðŸš€ è°ƒç”¨å¸¦æ ‡ç­¾è¿‡æ»¤çš„è„‘å›¾åˆ—è¡¨API...');
    const tagResult = await mindMapService.getMindMapList(userId, tagQuery);
    
    console.log('âœ… èŽ·å–æˆåŠŸï¼');
    console.log('è¿”å›žç»“æžœ:');
    console.log('- æ€»æ•°:', tagResult.total);
    console.log('- è„‘å›¾æ•°é‡:', tagResult.items.length);
    console.log('- è¿‡æ»¤åŽçš„è„‘å›¾:', tagResult.items.map(item => item.title));
    
    // éªŒè¯æ ‡ç­¾è¿‡æ»¤ç»“æžœ
    const tagValidations = [
      { field: 'total', value: tagResult.total, check: (v) => v === 2 }, // åªæœ‰å‰ä¸¤ä¸ªåŒ…å«"æµ‹è¯•"æ ‡ç­¾
      { field: 'items.length', value: tagResult.items.length, check: (v) => v === 2 },
      { field: 'filtered correctly', value: tagResult.items.every(item => item.tags?.includes('æµ‹è¯•')), check: (v) => v === true },
    ];
    
    for (const validation of tagValidations) {
      const isValid = validation.check(validation.value);
      if (isValid) {
        console.log(`âœ… ${validation.field}: éªŒè¯é€šè¿‡`);
      } else {
        console.log(`âŒ ${validation.field}: éªŒè¯å¤±è´¥`, validation.value);
        allValid = false;
      }
    }
    
    // æµ‹è¯•3: åˆ†é¡µåŠŸèƒ½
    console.log('\nðŸ“ æµ‹è¯•3: åˆ†é¡µåŠŸèƒ½');
    const pageQuery: MindMapQueryParams = {
      page: 1,
      pageSize: 2, // é™åˆ¶æ¯é¡µ2ä¸ª
    };
    
    console.log('æŸ¥è¯¢å‚æ•°:', pageQuery);
    
    console.log('ðŸš€ è°ƒç”¨åˆ†é¡µè„‘å›¾åˆ—è¡¨API...');
    const pageResult = await mindMapService.getMindMapList(userId, pageQuery);
    
    console.log('âœ… èŽ·å–æˆåŠŸï¼');
    console.log('è¿”å›žç»“æžœ:');
    console.log('- æ€»æ•°:', pageResult.total);
    console.log('- å½“å‰é¡µå¤§å°:', pageResult.pageSize);
    console.log('- å®žé™…è¿”å›žæ•°é‡:', pageResult.items.length);
    console.log('- æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ:', pageResult.hasMore);

    // éªŒè¯åˆ†é¡µç»“æžœ
    const pageValidations = [
      { field: 'pageSize', value: pageResult.pageSize, check: (v) => v === 2 },
      { field: 'items.length', value: pageResult.items.length, check: (v) => v === 2 },
      { field: 'hasNextPage', value: pageResult.hasMore, check: (v) => v === true },
    ];
    
    for (const validation of pageValidations) {
      const isValid = validation.check(validation.value);
      if (isValid) {
        console.log(`âœ… ${validation.field}: éªŒè¯é€šè¿‡`);
      } else {
        console.log(`âŒ ${validation.field}: éªŒè¯å¤±è´¥`, validation.value);
        allValid = false;
      }
    }
    
    if (allValid) {
      console.log('\nðŸŽ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼è„‘å›¾åˆ—è¡¨APIåŠŸèƒ½æ­£å¸¸');
      return true;
    } else {
      console.log('\nâŒ éƒ¨åˆ†éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®žçŽ°');
      return false;
    }
    
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    console.error('é”™è¯¯è¯¦æƒ…:', error);
    return false;
  }
}

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
  testListMindMapAPI()
    .then(success => {
      console.log('\nðŸ“Š æµ‹è¯•ç»“æžœ:', success ? 'æˆåŠŸ' : 'å¤±è´¥');
      process.exit(success ? 0 : 1);
    })
    .catch(error => {
      console.error('æµ‹è¯•æ‰§è¡Œé”™è¯¯:', error);
      process.exit(1);
    });
}

export { testListMindMapAPI };
