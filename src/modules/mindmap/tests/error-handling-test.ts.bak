/**
 * APIé”™è¯¯å¤„ç†æµ‹è¯•
 * éªŒè¯ç‚¹ï¼šé”™è¯¯æƒ…å†µä¸‹è¿”å›žæ­£ç¡®çš„é”™è¯¯å“åº”
 */

import { MindMapService } from '../mindmap.service';
import { MindMapController } from '../mindmap.controller';
import { ConfigService } from '@nestjs/config';
import { NotFoundException, BadRequestException, ConflictException } from '@nestjs/common';

// æ¨¡æ‹ŸConfigService
const mockConfigService = {
  getOrThrow: (key: string) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || `mock-${key}`;
  },
  get: (key: string, defaultValue?: any) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || defaultValue;
  },
} as ConfigService;

// æ¨¡æ‹Ÿä¼šæŠ›å‡ºå„ç§å¼‚å¸¸çš„DynamoDBå®¢æˆ·ç«¯
const createMockDynamoDBWithErrors = (errorType: string) => ({
  put: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB PUTæ“ä½œ - å°†æŠ›å‡ºå¼‚å¸¸:', errorType);
    
    switch (errorType) {
      case 'ConditionalCheckFailedException':
        const conditionalError = new Error('The conditional request failed');
        conditionalError.name = 'ConditionalCheckFailedException';
        throw conditionalError;
      case 'ValidationException':
        const validationError = new Error('One or more parameter values were invalid');
        validationError.name = 'ValidationException';
        throw validationError;
      case 'ResourceNotFoundException':
        const resourceError = new Error('Requested resource not found');
        resourceError.name = 'ResourceNotFoundException';
        throw resourceError;
      case 'ServiceUnavailableException':
        const serviceError = new Error('Service is temporarily unavailable');
        serviceError.name = 'ServiceUnavailableException';
        throw serviceError;
      default:
        throw new Error('Unknown database error');
    }
  },
  get: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB GETæ“ä½œ - å°†æŠ›å‡ºå¼‚å¸¸:', errorType);
    
    if (errorType === 'ResourceNotFoundException') {
      const error = new Error('Requested resource not found');
      error.name = 'ResourceNotFoundException';
      throw error;
    }
    
    return { Item: null };
  },
  delete: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB DELETEæ“ä½œ - å°†æŠ›å‡ºå¼‚å¸¸:', errorType);
    
    if (errorType === 'ConditionalCheckFailedException') {
      const error = new Error('The conditional request failed');
      error.name = 'ConditionalCheckFailedException';
      throw error;
    }
    
    return { $metadata: { httpStatusCode: 200 } };
  },
  query: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB QUERYæ“ä½œ - å°†æŠ›å‡ºå¼‚å¸¸:', errorType);
    
    if (errorType === 'ProvisionedThroughputExceededException') {
      const error = new Error('The level of configured provisioned throughput for the table was exceeded');
      error.name = 'ProvisionedThroughputExceededException';
      throw error;
    }
    
    return { Items: [], Count: 0 };
  },
});

async function testErrorHandling() {
  console.log('ðŸ§ª å¼€å§‹æµ‹è¯•APIé”™è¯¯å¤„ç†...');
  
  let allTestsPassed = true;
  
  try {
    // æµ‹è¯•1: NotFoundExceptionå¤„ç†
    console.log('\nðŸ“ æµ‹è¯•1: NotFoundExceptionå¤„ç†');
    const service1 = new MindMapService(mockConfigService);
    (service1 as any).db = createMockDynamoDBWithErrors('ResourceNotFoundException');
    
    try {
      await service1.getMindMapById('test-user', 'non-existent-id');
      console.log('âŒ åº”è¯¥æŠ›å‡ºNotFoundExceptionï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      allTestsPassed = false;
    } catch (error) {
      if (error instanceof NotFoundException) {
        console.log('âœ… æ­£ç¡®æŠ›å‡ºNotFoundException');
        console.log('- é”™è¯¯æ¶ˆæ¯:', error.message);
      } else {
        console.log('âŒ æŠ›å‡ºäº†é”™è¯¯çš„å¼‚å¸¸ç±»åž‹:', error.constructor.name);
        allTestsPassed = false;
      }
    }
    
    // æµ‹è¯•2: ConflictExceptionå¤„ç†ï¼ˆæ¡ä»¶æ£€æŸ¥å¤±è´¥ï¼‰
    console.log('\nðŸ“ æµ‹è¯•2: ConflictExceptionå¤„ç†');
    const service2 = new MindMapService(mockConfigService);
    (service2 as any).db = createMockDynamoDBWithErrors('ConditionalCheckFailedException');
    
    try {
      await service2.createMindMap('test-user', {
        title: 'æµ‹è¯•è„‘å›¾',
        description: 'æµ‹è¯•æè¿°',
        data: { data: { text: 'æ ¹èŠ‚ç‚¹' }, children: [] },
        tags: ['æµ‹è¯•'],
      });
      console.log('âŒ åº”è¯¥æŠ›å‡ºConflictExceptionï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      allTestsPassed = false;
    } catch (error) {
      if (error instanceof ConflictException) {
        console.log('âœ… æ­£ç¡®æŠ›å‡ºConflictException');
        console.log('- é”™è¯¯æ¶ˆæ¯:', error.message);
      } else {
        console.log('âŒ æŠ›å‡ºäº†é”™è¯¯çš„å¼‚å¸¸ç±»åž‹:', error.constructor.name);
        console.log('- å®žé™…é”™è¯¯:', error.message);
        allTestsPassed = false;
      }
    }
    
    // æµ‹è¯•3: BadRequestExceptionå¤„ç†ï¼ˆéªŒè¯å¼‚å¸¸ï¼‰
    console.log('\nðŸ“ æµ‹è¯•3: BadRequestExceptionå¤„ç†');
    const service3 = new MindMapService(mockConfigService);
    (service3 as any).db = createMockDynamoDBWithErrors('ValidationException');
    
    try {
      await service3.createMindMap('test-user', {
        title: 'æµ‹è¯•è„‘å›¾',
        description: 'æµ‹è¯•æè¿°',
        data: { data: { text: 'æ ¹èŠ‚ç‚¹' }, children: [] },
        tags: ['æµ‹è¯•'],
      });
      console.log('âŒ åº”è¯¥æŠ›å‡ºBadRequestExceptionï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      allTestsPassed = false;
    } catch (error) {
      if (error instanceof BadRequestException) {
        console.log('âœ… æ­£ç¡®æŠ›å‡ºBadRequestException');
        console.log('- é”™è¯¯æ¶ˆæ¯:', error.message);
      } else {
        console.log('âŒ æŠ›å‡ºäº†é”™è¯¯çš„å¼‚å¸¸ç±»åž‹:', error.constructor.name);
        console.log('- å®žé™…é”™è¯¯:', error.message);
        allTestsPassed = false;
      }
    }
    
    // æµ‹è¯•4: æŽ§åˆ¶å™¨é”™è¯¯å¤„ç†
    console.log('\nðŸ“ æµ‹è¯•4: æŽ§åˆ¶å™¨é”™è¯¯å¤„ç†');
    const service4 = new MindMapService(mockConfigService);
    (service4 as any).db = createMockDynamoDBWithErrors('ResourceNotFoundException');
    const controller = new MindMapController(service4);
    
    const mockRequest = { user: { sub: 'test-user' } };
    const response = await controller.getMindMapById('non-existent-id', mockRequest);
    
    console.log('æŽ§åˆ¶å™¨å“åº”:', {
      success: response.success,
      message: response.message,
      hasData: !!response.data,
    });
    
    if (!response.success && response.message) {
      console.log('âœ… æŽ§åˆ¶å™¨æ­£ç¡®å¤„ç†äº†é”™è¯¯');
      console.log('- é”™è¯¯æ¶ˆæ¯:', response.message);
    } else {
      console.log('âŒ æŽ§åˆ¶å™¨æ²¡æœ‰æ­£ç¡®å¤„ç†é”™è¯¯');
      allTestsPassed = false;
    }
    
    // æµ‹è¯•5: æœåŠ¡ä¸å¯ç”¨å¼‚å¸¸å¤„ç†
    console.log('\nðŸ“ æµ‹è¯•5: æœåŠ¡ä¸å¯ç”¨å¼‚å¸¸å¤„ç†');
    const service5 = new MindMapService(mockConfigService);
    (service5 as any).db = createMockDynamoDBWithErrors('ServiceUnavailableException');
    
    try {
      await service5.createMindMap('test-user', {
        title: 'æµ‹è¯•è„‘å›¾',
        description: 'æµ‹è¯•æè¿°',
        data: { data: { text: 'æ ¹èŠ‚ç‚¹' }, children: [] },
        tags: ['æµ‹è¯•'],
      });
      console.log('âŒ åº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      allTestsPassed = false;
    } catch (error) {
      console.log('âœ… æ­£ç¡®æŠ›å‡ºæœåŠ¡å¼‚å¸¸');
      console.log('- å¼‚å¸¸ç±»åž‹:', error.constructor.name);
      console.log('- é”™è¯¯æ¶ˆæ¯:', error.message);
    }
    
    // æµ‹è¯•6: é™æµå¼‚å¸¸å¤„ç†
    console.log('\nðŸ“ æµ‹è¯•6: é™æµå¼‚å¸¸å¤„ç†');
    const service6 = new MindMapService(mockConfigService);
    (service6 as any).db = createMockDynamoDBWithErrors('ProvisionedThroughputExceededException');
    
    try {
      await service6.getMindMapList('test-user', { page: 1, pageSize: 10 });
      console.log('âŒ åº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      allTestsPassed = false;
    } catch (error) {
      console.log('âœ… æ­£ç¡®æŠ›å‡ºé™æµå¼‚å¸¸');
      console.log('- å¼‚å¸¸ç±»åž‹:', error.constructor.name);
      console.log('- é”™è¯¯æ¶ˆæ¯:', error.message);
    }
    
    if (allTestsPassed) {
      console.log('\nðŸŽ‰ æ‰€æœ‰é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡ï¼APIé”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸');
      return true;
    } else {
      console.log('\nâŒ éƒ¨åˆ†é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®žçŽ°');
      return false;
    }
    
  } catch (error) {
    console.error('âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥:', error.message);
    console.error('é”™è¯¯è¯¦æƒ…:', error);
    return false;
  }
}

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
  testErrorHandling()
    .then(success => {
      console.log('\nðŸ“Š æµ‹è¯•ç»“æžœ:', success ? 'æˆåŠŸ' : 'å¤±è´¥');
      process.exit(success ? 0 : 1);
    })
    .catch(error => {
      console.error('æµ‹è¯•æ‰§è¡Œé”™è¯¯:', error);
      process.exit(1);
    });
}

export { testErrorHandling };
