/**
 * åˆ é™¤è„‘å›¾APIæµ‹è¯•
 * éªŒè¯ç‚¹ï¼šå¯ä»¥æˆåŠŸåˆ é™¤è„‘å›¾è®°å½•
 */

import { MindMapService } from '../mindmap.service';
import { ConfigService } from '@nestjs/config';
import { MINDMAP_DEFAULTS } from '../types/mindmap.types';

// æ¨¡æ‹Ÿå­˜å‚¨çš„è„‘å›¾æ•°æ®
let mockStoredData: any = {
  'USER#test-user-123#MINDMAP#test-mindmap-123': {
    PK: 'USER#test-user-123',
    SK: 'MINDMAP#test-mindmap-123',
    id: 'test-mindmap-123',
    userId: 'test-user-123',
    title: 'å¾…åˆ é™¤çš„è„‘å›¾',
    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºŽæµ‹è¯•åˆ é™¤åŠŸèƒ½çš„è„‘å›¾',
    data: JSON.stringify({
      data: {
        text: 'æ ¹èŠ‚ç‚¹',
        expand: true,
      },
      children: []
    }),
    layout: MINDMAP_DEFAULTS.LAYOUT,
    theme: MINDMAP_DEFAULTS.THEME,
    version: MINDMAP_DEFAULTS.VERSION,
    createdAt: '2025-07-02T13:00:00.000Z',
    updatedAt: '2025-07-02T13:00:00.000Z',
  }
};

// æ¨¡æ‹ŸDynamoDBæ“ä½œ
const mockDynamoDBDocument = {
  put: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB PUTæ“ä½œ:', {
      TableName: params.TableName,
      PK: params.Item.PK,
      SK: params.Item.SK,
      title: params.Item.title,
    });
    return { $metadata: { httpStatusCode: 200 } };
  },
  get: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB GETæ“ä½œ:', params.Key);
    
    const key = `${params.Key.PK}#${params.Key.SK}`;
    const item = mockStoredData[key];
    
    return { Item: item || null };
  },
  delete: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB DELETEæ“ä½œ:', params.Key);
    
    const key = `${params.Key.PK}#${params.Key.SK}`;
    const exists = !!mockStoredData[key];
    
    if (!exists && params.ConditionExpression) {
      // æ¨¡æ‹Ÿæ¡ä»¶æ£€æŸ¥å¤±è´¥
      const error = new Error('The conditional request failed');
      error.name = 'ConditionalCheckFailedException';
      throw error;
    }
    
    // åˆ é™¤æ•°æ®
    delete mockStoredData[key];
    
    return { $metadata: { httpStatusCode: 200 } };
  },
  query: async (params: any) => {
    console.log('ðŸ”§ æ¨¡æ‹ŸDynamoDB QUERYæ“ä½œ:', params.KeyConditionExpression);
    return { Items: [], Count: 0 };
  },
};

// æ¨¡æ‹ŸConfigService
const mockConfigService = {
  getOrThrow: (key: string) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || `mock-${key}`;
  },
  get: (key: string, defaultValue?: any) => {
    const config = {
      'AWS_REGION': 'us-east-1',
      'MINDMAP_TABLE_NAME': 'mindmap-test-table',
    };
    return config[key] || defaultValue;
  },
} as ConfigService;

async function testDeleteMindMapAPI() {
  console.log('ðŸ§ª å¼€å§‹æµ‹è¯•åˆ é™¤è„‘å›¾API...');
  
  try {
    // åˆ›å»ºæœåŠ¡å®žä¾‹
    const mindMapService = new MindMapService(mockConfigService);
    
    // æ¨¡æ‹ŸDynamoDBå®¢æˆ·ç«¯
    (mindMapService as any).db = mockDynamoDBDocument;
    
    // æµ‹è¯•1: åˆ é™¤å­˜åœ¨çš„è„‘å›¾
    console.log('\nðŸ“ æµ‹è¯•1: åˆ é™¤å­˜åœ¨çš„è„‘å›¾');
    const userId = 'test-user-123';
    const mindMapId = 'test-mindmap-123';
    
    console.log('ç”¨æˆ·ID:', userId);
    console.log('è„‘å›¾ID:', mindMapId);
    
    // éªŒè¯è„‘å›¾å­˜åœ¨
    const key = `USER#${userId}#MINDMAP#${mindMapId}`;
    console.log('åˆ é™¤å‰è„‘å›¾æ˜¯å¦å­˜åœ¨:', !!mockStoredData[key]);
    
    // è°ƒç”¨åˆ é™¤API
    console.log('ðŸš€ è°ƒç”¨åˆ é™¤è„‘å›¾API...');
    await mindMapService.deleteMindMap(userId, mindMapId);
    
    // éªŒè¯åˆ é™¤ç»“æžœ
    console.log('âœ… åˆ é™¤æˆåŠŸï¼');
    console.log('åˆ é™¤åŽè„‘å›¾æ˜¯å¦å­˜åœ¨:', !!mockStoredData[key]);
    
    // éªŒè¯è„‘å›¾ç¡®å®žè¢«åˆ é™¤
    if (!mockStoredData[key]) {
      console.log('âœ… è„‘å›¾å·²æˆåŠŸä»Žå­˜å‚¨ä¸­åˆ é™¤');
    } else {
      console.log('âŒ è„‘å›¾ä»ç„¶å­˜åœ¨äºŽå­˜å‚¨ä¸­');
      return false;
    }
    
    // æµ‹è¯•2: åˆ é™¤ä¸å­˜åœ¨çš„è„‘å›¾
    console.log('\nðŸ“ æµ‹è¯•2: åˆ é™¤ä¸å­˜åœ¨çš„è„‘å›¾');
    const nonExistentId = 'non-existent-mindmap';
    console.log('è„‘å›¾ID:', nonExistentId);
    
    try {
      console.log('ðŸš€ è°ƒç”¨åˆ é™¤ä¸å­˜åœ¨è„‘å›¾API...');
      await mindMapService.deleteMindMap(userId, nonExistentId);
      console.log('âŒ åº”è¯¥æŠ›å‡ºNotFoundExceptionï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      return false;
    } catch (error) {
      if (error.name === 'NotFoundException') {
        console.log('âœ… æ­£ç¡®æŠ›å‡ºNotFoundException');
      } else {
        console.log('âŒ æŠ›å‡ºäº†é”™è¯¯çš„å¼‚å¸¸ç±»åž‹:', error.name);
        console.log('é”™è¯¯è¯¦æƒ…:', error.message);
        return false;
      }
    }
    
    // æµ‹è¯•3: éªŒè¯åˆ é™¤æ“ä½œçš„å¹‚ç­‰æ€§ï¼ˆå†æ¬¡åˆ é™¤å·²åˆ é™¤çš„è„‘å›¾ï¼‰
    console.log('\nðŸ“ æµ‹è¯•3: éªŒè¯åˆ é™¤æ“ä½œçš„å¹‚ç­‰æ€§');
    console.log('è„‘å›¾ID:', mindMapId, '(å·²åˆ é™¤)');
    
    try {
      console.log('ðŸš€ å†æ¬¡è°ƒç”¨åˆ é™¤å·²åˆ é™¤è„‘å›¾API...');
      await mindMapService.deleteMindMap(userId, mindMapId);
      console.log('âŒ åº”è¯¥æŠ›å‡ºNotFoundExceptionï¼Œä½†æ²¡æœ‰æŠ›å‡º');
      return false;
    } catch (error) {
      if (error.name === 'NotFoundException') {
        console.log('âœ… æ­£ç¡®æŠ›å‡ºNotFoundExceptionï¼ˆå¹‚ç­‰æ€§éªŒè¯é€šè¿‡ï¼‰');
      } else {
        console.log('âŒ æŠ›å‡ºäº†é”™è¯¯çš„å¼‚å¸¸ç±»åž‹:', error.name);
        console.log('é”™è¯¯è¯¦æƒ…:', error.message);
        return false;
      }
    }
    
    console.log('\nðŸŽ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼åˆ é™¤è„‘å›¾APIåŠŸèƒ½æ­£å¸¸');
    return true;
    
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    console.error('é”™è¯¯è¯¦æƒ…:', error);
    return false;
  }
}

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
  testDeleteMindMapAPI()
    .then(success => {
      console.log('\nðŸ“Š æµ‹è¯•ç»“æžœ:', success ? 'æˆåŠŸ' : 'å¤±è´¥');
      process.exit(success ? 0 : 1);
    })
    .catch(error => {
      console.error('æµ‹è¯•æ‰§è¡Œé”™è¯¯:', error);
      process.exit(1);
    });
}

export { testDeleteMindMapAPI };
